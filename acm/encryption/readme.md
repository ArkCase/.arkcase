# Introduction
The implemented encryption of a plaintext in ArkCase is done in two steps. First, encrypt the plaintext with a symmetric key (a plain old password, in core branch it is **changeme**).
Then, encrypt the symmetric key using a public key. To decrypt, first decrypt the encrypted symmetric key with the corresponding private key, then decrypt the plaintext with the symmetric key.

# Encrypt a plaintext (property value) with the symmetric key

To encrypt a plaintext create a file **plaintextFile** containing the plaintext to encrypt. Run the following command:
```
openssl enc -md sha256 -aes-256-cbc -a -v -in plaintextFile -out plaintextFile.encrypted -p
```
Use the symmetric key as passphrase (in core branch it is **changeme**)

# Use the encrypted plaintext in a property file

Copy the encrypted plaintext value from the **plainText.encrypted** file from above and paste it as a property value enclosed in **ENC(encryptedValue)**.

For example the property value **arkcase** in *datasource.Properties* file:
```
acm.password=arkcase
```
would become:
```
acm.password=ENC(U2FsdGVkX1+gINVHslXEq42y8nJcMndeDQTnoa7uKjU=)
```

# Using your own private key and symmetric key
To use your own private key, follow the instructions in **_<user.home>/.arkcase/acm/private/readme.md_**, to create the **_keystore_** file.
To use your own symmetric key (a plain old password) you will need to generate the encrypted symmetric key located in this directory.

### The public key
To extract the public key from the **_keystore_** file you'll need to follow these two steps:
1. Extract the certificate from the keystore
    ```
    keytool -exportcert -alias <certificateAlias> -keypass <privateKeyPassword> -keystore <keystore> -storepass <keystorePassword> -rfc -file <certificateFileName>
    ```
    Example:
    ```
    keytool -exportcert -alias armedia -keypass changeme -keystore keystore -storepass password -rfc -file arkcase.cert
    ```
2. Extract the public key from the certificate
    ```
    openssl x509 -pubkey -noout -in <certificateFileName> > <publicKeyFile>
    ```
   Example:
    ```
    openssl x509 -pubkey -noout -in arkcase.cert  > arkcase-pub.pem
    ```

### The encrypted symmetric key
The encrypted symmetric key should be placed in **_<user.home>/.arkcase/acm/encryption/symmetricKey.encrypted_**. This path can be changed in **_<user.home>/.arkcase/acm/encryption/spring-properties-encryption.xml_** file, in the value of the property **encryptedSymmetricKeyFilePath**.

The encrypted symmetric key is generated by encrypting the symmetric key (a plain old password) with the public key.
For example to create the encrypted symmetric key file, create a **symmetricKeyFile** containing the symmetric key (a plain old password) and run the following command:
```
openssl rsautl -encrypt -pubin -inkey <publicKeyFile> -in <symetricKeyFile> -out <encryptedSymetricKeyFile>
```
Example:
```
openssl rsautl -encrypt -pubin -inkey arkcase-pub.pem -in symmetricKeyFile -out symmetricKey.encrypted
```

## Known properties files containing passwords/passphrases

- datasource.properties (two properties)
- acmEmailReceiver.properties
- acm-forms.properties
- acm-reports-server-config.properties
- alfrescoRmaPlugin.properties
- cmis.properties
- msOutlookIntegration.properties
- notification.properties
- websockets.properties (no need to encrypt passwords as these are keystore passwords)
- spring-config-XXX-ldap.properties (should be generated through admin automatically)
- spring-config-kerberos.properties