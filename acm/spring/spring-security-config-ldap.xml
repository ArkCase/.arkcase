<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
             xmlns:beans="http://www.springframework.org/schema/beans"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.1.xsd
                        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.2.xsd">

	<!-- acmAuthenticationManager, acmLoginSuccessHandler, acmLogoutSuccessHandler, acmAuthenticationDetailsFactory, acmAthenticationCheckFilter, 
        acmBasicAndTokenAuthenticationFilter, acmRestAuthenticationSuccessHandler, acmRestAuthenticationFailureHandler, acmRestAuthenticationEntryPoint
        are defined in spring-library-user-login.xml -->

    <!-- Ldap Entry Point authenticates users against LDAP server for static application resources -->
    <http 
        entry-point-ref="acmStaticResourcesAuthenticationEntryPoint"
        use-expressions="true"
        request-matcher="regex"
        pattern="^/assets/.*$|^/custom_assets/.*$|^/directives/.*$|^/custom_directives/.*$|^/filters/.*$|^/modules/.*$|^/custom_modules/.*$|^/modules_config/.*$|^/services/.*$"
        authentication-manager-ref="acmAuthenticationManager">
        <intercept-url pattern="^/.*$" access="isAuthenticated()" />
        <http-basic/>
        <custom-filter ref="acmBasicAndTokenAuthenticationFilter" before="BASIC_AUTH_FILTER"/>
        <custom-filter ref="corsFilter" after="PRE_AUTH_FILTER"/>
        <form-login
            authentication-success-handler-ref="acmRestAuthenticationSuccessHandler"
            authentication-failure-handler-ref="acmRestAuthenticationFailureHandler" />      
    </http>

    <!-- Ldap Entry Point authenticates users against LDAP server for REST calls -->
    <http 
        entry-point-ref="acmRestAuthenticationEntryPoint"
        use-expressions="true"
        request-matcher="regex"
        pattern="^/api/.*$|^/plugin/.*$"
        authentication-manager-ref="acmAuthenticationManager">
        <intercept-url pattern="^/.*$" access="isAuthenticated()" />
        <http-basic/>
        <custom-filter ref="acmBasicAndTokenAuthenticationFilter" before="BASIC_AUTH_FILTER"/>
        <custom-filter ref="corsFilter" after="PRE_AUTH_FILTER"/>
        <form-login
            authentication-success-handler-ref="acmRestAuthenticationSuccessHandler"
            authentication-failure-handler-ref="acmRestAuthenticationFailureHandler" />      
    </http>
   
	<!-- Ldap Entry Point authenticates users against LDAP server for regular calls -->
    <http
        auto-config="true"
        use-expressions="true"
        authentication-manager-ref="acmAuthenticationManager">
        <intercept-url pattern="/**" access="isAuthenticated()" />
        <http-basic/>
        <custom-filter ref="acmBasicAndTokenAuthenticationFilter" before="BASIC_AUTH_FILTER"/>
        <custom-filter ref="corsFilter" after="PRE_AUTH_FILTER"/>
		<form-login
                login-page="/login"
                default-target-url="/home.html#!/welcome"
                authentication-details-source-ref="acmAuthenticationDetailsFactory"
                authentication-failure-url="/login?login_error"
                authentication-success-handler-ref="acmLoginSuccessHandler"/>
		<logout
                logout-url="/logout"
                delete-cookies="JSESSIONID"
                success-handler-ref="acmLogoutSuccessHandler"
                invalidate-session="true"/>
        <session-management invalid-session-url="/login?login_error=1">
            <!--this will throw error to 3rd login attempt -->
            <!--<concurrency-control max-sessions="3" error-if-maximum-exceeded="true" /> -->
        </session-management>
    </http>
	
	<beans:bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <beans:property name="location" value="file:${user.home}/.arkcase/acm/spring/spring-config-armedia-ldap.properties"/>
    </beans:bean>

    <beans:bean id="armedia_userSearch"
                class="org.springframework.security.ldap.search.FilterBasedLdapUserSearch">
        <beans:constructor-arg index="0" value="CN=Users" />
        <beans:constructor-arg index="1" value='${ldapConfig.userIdAttributeName}={0}' />
        <beans:constructor-arg index="2" ref="armedia_contextSource" />
    </beans:bean>

    <beans:bean id="armedia_authenticationProvider"
                class="org.springframework.security.ldap.authentication.LdapAuthenticationProvider">
        <beans:constructor-arg>
            <beans:bean
                    class="org.springframework.security.ldap.authentication.BindAuthenticator">
                <beans:constructor-arg ref="armedia_contextSource" />
                <beans:property name="userSearch" ref="armedia_userSearch"/>
            </beans:bean>
        </beans:constructor-arg>
        <beans:constructor-arg>
            <beans:bean
                    class="org.springframework.security.ldap.userdetails.DefaultLdapAuthoritiesPopulator">
                <beans:constructor-arg ref="armedia_contextSource" />
                <beans:constructor-arg value="OU=Groups,OU=ACM3,OU=Clients"/>
                <beans:property name="groupSearchFilter" value="member={0}"/>
                <beans:property name="rolePrefix" value=""/>
                <beans:property name="searchSubtree" value="true"/>
                <beans:property name="convertToUpperCase" value="true"/>
                <beans:property name="ignorePartialResultException" value="true"/>
            </beans:bean>
        </beans:constructor-arg>
    </beans:bean>

    <beans:bean id="armedia_contextSource"
                class="org.springframework.ldap.core.support.LdapContextSource">
        <beans:property name="url" value='${ldapConfig.ldapUrl}' />
        <beans:property name="base" value='${ldapConfig.base}' />
        <beans:property name="userDn" value='${ldapConfig.authUserDn}' />
        <beans:property name="password" value='${ldapConfig.authUserPassword}' />
        <beans:property name="pooled" value="true" />
        <!-- AD Specific Setting for avoiding the partial exception error -->
        <beans:property name="referral" value="follow" />
    </beans:bean>

    <beans:bean id="logoutUrl" class="java.lang.String">
        <beans:constructor-arg value="logout" />
    </beans:bean>
	
</beans:beans>
